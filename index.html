<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AgriSense AI | Live Diagnosis</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background: #f0f4f0; }
        .prose h3 { color: #1B5E20; font-weight: 700; margin-top: 1rem; border-bottom: 1px solid #e2e8f0; }
        .prose ul { list-style-type: disc; padding-left: 1.5rem; margin-bottom: 0.5rem; }
        .spinner { border-top-color: #2E7D32; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        #video-feed { transform: scaleX(1); } /* Flip for selfie if needed, but usually leave 1 for rear cam */
    </style>
</head>
<body class="p-2 md:p-8">

    <div class="max-w-3xl mx-auto bg-white rounded-3xl shadow-2xl overflow-hidden border border-gray-100">
        <div class="bg-green-800 p-6 text-white text-center">
            <h1 class="text-3xl font-extrabold mb-1">ðŸŒ¿ AgriSense AI</h1>
            <p class="opacity-90 italic">Point, Shoot, & Heal Your Crops</p>
        </div>

        <div class="p-4 md:p-6">
            <div id="key-banner" class="mb-4 p-3 bg-amber-50 border-l-4 border-amber-400 text-amber-800 text-sm rounded flex justify-between items-center">
                <span><strong>Setup:</strong> API Key needed for AI.</span>
                <button onclick="setApiKey()" class="underline font-bold">Enter Key</button>
            </div>

            <div class="space-y-4">
                
                <div class="relative w-full aspect-square md:aspect-video bg-black rounded-2xl overflow-hidden shadow-inner border-4 border-gray-200">
                    <video id="video-feed" class="w-full h-full object-cover hidden" autoplay playsinline></video>
                    <canvas id="canvas" class="hidden"></canvas>
                    <img id="preview" class="w-full h-full object-cover hidden">
                    
                    <div id="idle-msg" class="absolute inset-0 flex flex-col items-center justify-center text-gray-400 bg-gray-50">
                        <svg class="w-16 h-16 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"/><circle cx="12" cy="13" r="4"/></svg>
                        <p>Camera inactive</p>
                    </div>
                </div>

                <div class="grid grid-cols-2 md:grid-cols-4 gap-2">
                    <button id="start-camera" onclick="initCamera()" class="p-3 bg-blue-600 text-white rounded-xl font-bold text-sm hover:bg-blue-700">Open Camera</button>
                    <button id="capture-btn" onclick="takePhoto()" class="p-3 bg-red-500 text-white rounded-xl font-bold text-sm hidden">Capture Photo</button>
                    <label class="p-3 bg-gray-200 text-gray-700 rounded-xl font-bold text-sm text-center cursor-pointer hover:bg-gray-300">
                        Upload File
                        <input type="file" class="hidden" accept="image/*" onchange="handleFileUpload(this)">
                    </label>
                    <button id="analyze-btn" disabled onclick="startAnalysis()" class="p-3 bg-green-600 text-white rounded-xl font-bold text-sm disabled:bg-gray-300">Run AI Analysis</button>
                </div>
            </div>

            <div id="loader" class="hidden py-10 text-center">
                <div class="spinner border-4 border-gray-200 rounded-full w-10 h-10 mx-auto mb-4"></div>
                <p class="text-green-800 font-bold animate-pulse">AI is identifying your crop...</p>
            </div>

            <div id="result-container" class="hidden mt-6">
                <div class="p-1 bg-gradient-to-r from-green-400 to-blue-500 rounded-2xl shadow-lg">
                    <div id="report-content" class="prose prose-sm max-w-none bg-white p-6 rounded-xl border border-gray-100"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let selectedImage = null;
        let API_KEY = localStorage.getItem('GEMINI_KEY');
        const video = document.getElementById('video-feed');
        const canvas = document.getElementById('canvas');
        const preview = document.getElementById('preview');
        const idleMsg = document.getElementById('idle-msg');

        if (API_KEY) updateKeyUI();

        function setApiKey() {
            const key = prompt("Paste your Gemini API Key:");
            if (key) {
                localStorage.setItem('GEMINI_KEY', key);
                API_KEY = key;
                updateKeyUI();
            }
        }

        function updateKeyUI() {
            document.getElementById('key-banner').innerHTML = `
                <span class="text-green-700 text-xs font-bold">âœ… API Key Ready</span>
                <button onclick="localStorage.removeItem('GEMINI_KEY'); location.reload();" class="text-red-600 text-xs underline">Clear</button>
            `;
            document.getElementById('key-banner').className = "mb-4 p-2 bg-green-50 border-l-4 border-green-500 rounded flex justify-between items-center";
        }

        async function initCamera() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: "environment" }, // Defaults to back camera
                    audio: false 
                });
                video.srcObject = stream;
                video.classList.remove('hidden');
                idleMsg.classList.add('hidden');
                preview.classList.add('hidden');
                document.getElementById('capture-btn').classList.remove('hidden');
            } catch (err) {
                alert("Camera access denied or not found.");
            }
        }

        function takePhoto() {
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            canvas.getContext('2d').drawImage(video, 0, 0);
            
            selectedImage = canvas.toDataURL('image/jpeg');
            preview.src = selectedImage;
            
            // Stop camera stream
            const stream = video.srcObject;
            if (stream) stream.getTracks().forEach(track => track.stop());
            
            video.classList.add('hidden');
            preview.classList.remove('hidden');
            document.getElementById('capture-btn').classList.add('hidden');
            document.getElementById('analyze-btn').disabled = false;
        }

        function handleFileUpload(input) {
            const file = input.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                selectedImage = e.target.result;
                preview.src = selectedImage;
                preview.classList.remove('hidden');
                video.classList.add('hidden');
                idleMsg.classList.add('hidden');
                document.getElementById('analyze-btn').disabled = false;
            };
            reader.readAsDataURL(file);
        }

        async function startAnalysis() {
            if (!API_KEY) return setApiKey();
            
            document.getElementById('loader').classList.remove('hidden');
            document.getElementById('result-container').classList.add('hidden');
            document.getElementById('analyze-btn').disabled = true;

            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${API_KEY}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{
                            parts: [
                                { text: "Analyze this agricultural image. Provide: 1. Crop Species Identification. 2. Diagnosis (Health/Disease/Pests). 3. Treatment plan (Chemical and Organic). 4. Next Steps for the farmer. Use bold markdown headers." },
                                { inline_data: { mime_type: "image/jpeg", data: selectedImage.split(',')[1] } }
                            ]
                        }]
                    })
                });

                const data = await response.json();
                const text = data.candidates[0].content.parts[0].text;
                document.getElementById('report-content').innerHTML = marked.parse(text);
                document.getElementById('result-container').classList.remove('hidden');
            } catch (error) {
                alert("AI Error: Please check your API key.");
            } finally {
                document.getElementById('loader').classList.add('hidden');
                document.getElementById('analyze-btn').disabled = false;
            }
        }
    </script>
</body>
</html>